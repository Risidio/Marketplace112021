<template>
  <div class="" v-if="!loading">
    <!-- <h1 class="pointer mb-4 border-bottom" @click="showMinted = !showMinted"><b-icon font-scale="0.6" v-if="showMinted" icon="chevron-down"/><b-icon font-scale="0.6" v-else icon="chevron-right"/> {{tokenCount}} Minted NFTs</h1>
    <div class="mb-4" v-if="showMinted && loopRun"> -->
      <Pagination @changePage="gotoPage" :pageSize="pageSize" :numberOfItems="numberOfItems" v-if="numberOfItems > 0" />
     <div class="galleryinfoContainer" id="my-table" v-if="resultSet && resultSet.length > 0">
        <!--  <div class="addNewContainer" stye="">
          <router-link to="/create">
            <p style="font-size: 150px; margin-top: 20px;font-weight: 300; color: grey;">&plus;</p>
            <p style="font-weight: 500; margin-top: 30px;"> Add new NFT</p>
            <p style="font-weight: 300;"> Do you have your own item and would like to add it to the marketplace? Mint it now!</p>
          </router-link>
          <div>
            <p style="font-weight: 500;">Create a collection</p>
            <p style="font-weight: 300;">create your own collection of artworks </p>
          </div>
        </div> -->
        <div v-for="(asset, index) of resultSet" :key="index">
          <MySingleItem @updateImage="updateImage" :parent="'list-view'" :loopRun="loopRun" :asset="asset" :key="componentKey" class=""/>
        </div>
      </div>
      <div v-else>
        <div class="noNFT">
        <h3> You do not own any Items yet</h3>
          <div class="profileBtns">
            <router-link class="button filled" to="/">Gallery</router-link>
            <!-- <router-link class="button notFilledBlue" to="/create">Mint Your Item</router-link> -->
          </div>
        </div>
      </div>
    </div>
  <!-- </div> -->
</template>

<script>
import MySingleItem from './MySingleItem'
import Pagination from './common/Pagination'
import { APP_CONSTANTS } from '@/app-constants'

const LOOP_RUN_DEF = process.env.VUE_APP_DEFAULT_LOOP_RUN

export default {
  name: 'MyPageableItems',
  components: {
    MySingleItem, Pagination
  },
  props: ['loopRun'],
  data () {
    return {
      showMinted: true,
      resultSet: [],
      tokenCount: null,
      pageSize: 500,
      loading: true,
      doPaging: true,
      numberOfItems: 0,
      componentKey: 0,
      nowOnPage: 0,
      currentRunKey: null
    }
  },
  mounted () {
    this.currentRunKey = this.loopRun.currentRunKey
    // this.numberOfItems = 500 // this.loopRun.tokenCount
    this.fetchPage(0)
    this.loading = false
    const $self = this
    let resizeTimer
    window.addEventListener('resize', function () {
      clearTimeout(resizeTimer)
      resizeTimer = setTimeout(function () {
        $self.componentKey += 1
      }, 400)
    })
    window.onscroll = () => {
      const bottomOfWindow = document.documentElement.scrollTop + window.innerHeight === document.documentElement.offsetHeight
      if (bottomOfWindow) {
        // $self.page++
        // $self.fetchPage()
      }
    }
  },
  methods: {
    updateImage () {
      // this.page = page - 1
      this.fetchPage(this.nowOnPage)
    },
    gotoPage (page) {
      this.nowOnPage = page - 1
      this.fetchPage(page - 1)
    },
    fetchPage (page) {
      const data = {
        // contractId: (this.loopRun) ? this.loopRun.contractId : STX_CONTRACT_ADDRESS + '.' + STX_CONTRACT_NAME,
        runKey: (this.loopRun) ? this.loopRun.currentRunKey : LOOP_RUN_DEF,
        stxAddress: this.profile.stxAddress,
        asc: true,
        page: page,
        pageSize: this.pageSize,
        contractId: this.loopRun.contractId
      }
      if (this.currentRunKey) data.runKey = this.currentRunKey
      // if (process.env.VUE_APP_NETWORK === 'local') {
      //   data.stxAddress = 'STFJEDEQB1Y1CQ7F04CS62DCS5MXZVSNXXN413ZG'
      // }
      this.resultSet = null
      this.$store.dispatch('rpayStacksContractStore/fetchMyTokens', data).then((result) => {
        this.resultSet = result.gaiaAssets // this.resultSet.concat(results)
        this.tokenCount = result.tokenCount
        this.numberOfItems = result.gaiaAssets.length
        this.loading = false
      }).catch((error) => {
        console.log(error)
      })
    }
  },
  computed: {
    profile () {
      const profile = this.$store.getters[APP_CONSTANTS.KEY_PROFILE]
      return profile
    },
    mintCounter () {
      const application = this.$store.getters[APP_CONSTANTS.KEY_APPLICATION_FROM_REGISTRY_BY_CONTRACT_ID](process.env.VUE_APP_STACKS_CONTRACT_ADDRESS + '.' + process.env.VUE_APP_STACKS_CONTRACT_NAME)
      return application.tokenContract.mintCounter
    }
  }
}
</script>
<style lang="scss" scoped>
.myItemsIntroText {font-weight: 200; font-size: 1.1rem; color: #fff;}
  .profileBtns{
    display: flex;
    flex-direction: row;
    justify-content: center;
    width: auto;
    margin: 20px auto auto auto;
  }
  .profileBtns{
  display: flex;
  justify-content: center;
  align-items: center;
  & > * {
    margin: 0 10px;
  }
  & > *:hover{
    color: white;
  }
}
  .noNFT{
  display: block;
  margin: auto;
  max-width: 100%;
  text-align: center;
  h3{
    margin: 50px 0;
    font-size: 40px;
    font-weight: 300;
  }
}
</style>
